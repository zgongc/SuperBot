{% extends "base.html" %}

{% block title %}Strateji Detay{% endblock %}

{# T√ºm stiller components.css'te: .strategy-detail-header, .strategy-title, .strategy-actions, .info-row, .status-badge, .symbol-tags, .loading-* #}

{% block content %}
<div id="loading-state" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Loading strategy...</p>
</div>

<div id="strategy-content" style="display: none;">
    <div class="strategy-detail-header">
        <div class="strategy-title-section">
            <h1 class="strategy-title" id="strategy-name">-</h1>
            <p class="strategy-version" id="strategy-version">-</p>
        </div>
        <div class="strategy-actions">
            <a href="/strategies" class="btn btn-secondary">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Back
            </a>
            <button class="btn btn-secondary" onclick="editStrategy()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit
            </button>
            <button class="btn btn-primary" id="toggle-btn" onclick="toggleStrategy()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Start
            </button>
        </div>
    </div>

    <div class="detail-grid">
        <!-- Metadata -->
        <div class="card">
            <div class="card-header">
                <h2>üìã Metadata</h2>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Author</span>
                    <span class="info-value" id="strategy-author">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Created Date</span>
                    <span class="info-value" id="strategy-created-date">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Display Info</span>
                    <span class="info-value" id="strategy-display-info">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Warmup Period</span>
                    <span class="info-value" id="strategy-warmup">-</span>
                </div>
            </div>
        </div>

        <!-- Trading Config -->
        <div class="card">
            <div class="card-header">
                <h2>‚öôÔ∏è Trading Config</h2>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Trading Side</span>
                    <span class="info-value" id="strategy-trading-side">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Leverage</span>
                    <span class="info-value" id="strategy-leverage">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Max Position Size</span>
                    <span class="info-value" id="strategy-max-position">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Primary Timeframe</span>
                    <span class="info-value" id="strategy-primary-tf">-</span>
                </div>
            </div>
        </div>

        <!-- Margin Config -->
        <div class="card">
            <div class="card-header">
                <h2>üí∞ Margin Config</h2>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Set Default Leverage</span>
                    <span class="info-value" id="strategy-set-leverage">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Hedge Mode</span>
                    <span class="info-value" id="strategy-hedge-mode">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Set Margin Type</span>
                    <span class="info-value" id="strategy-set-margin">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Margin Type</span>
                    <span class="info-value" id="strategy-margin-type">-</span>
                </div>
            </div>
        </div>

        <!-- Symbols -->
        <div class="card">
            <div class="card-header">
                <h2>Symbols (<span id="symbol-count">0</span>)</h2>
            </div>
            <div class="card-body">
                <div class="symbol-tags" id="symbol-tags">
                    <!-- Symbols will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Backtest Config -->
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header">
                <h2>üìà Backtest Configuration</h2>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="info-row" style="border: none;">
                        <span class="info-label">Enabled</span>
                        <span class="info-value" id="backtest-enabled">-</span>
                    </div>
                    <div class="info-row" style="border: none;">
                        <span class="info-label">Start Date</span>
                        <span class="info-value" id="backtest-start">-</span>
                    </div>
                    <div class="info-row" style="border: none;">
                        <span class="info-label">End Date</span>
                        <span class="info-value" id="backtest-end">-</span>
                    </div>
                    <div class="info-row" style="border: none;">
                        <span class="info-label">Initial Balance</span>
                        <span class="info-value" id="backtest-balance">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description -->
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header">
                <h2>Description</h2>
            </div>
            <div class="card-body">
                <p id="strategy-description" style="color: var(--text-secondary); line-height: 1.6;">-</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascriptArea %}
<script>
    const strategyId = '{{ strategy_id }}';
    let currentStrategy = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadStrategy();
    });

    async function loadStrategy() {
        try {
            const response = await fetch(`/api/strategies/${strategyId}`);
            const result = await response.json();

            if (result.status === 'success') {
                currentStrategy = result.data;
                renderStrategy();
            } else {
                showToast('Error', result.message || 'Strategy could not be loaded.', 'error');
                setTimeout(() => window.location.href = '/strategies', 2000);
            }
        } catch (error) {
            console.error('Error loading strategy:', error);
            showToast('Error', 'Error occurred while loading strategy.', 'error');
            setTimeout(() => window.location.href = '/strategies', 2000);
        } finally {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('strategy-content').style.display = 'block';
        }
    }

    function renderStrategy() {
        if (!currentStrategy) return;

        // Header
        document.getElementById('strategy-name').textContent = currentStrategy.name;
        document.getElementById('strategy-version').textContent = `v${currentStrategy.version}`;

        // Metadata
        document.getElementById('strategy-author').textContent = currentStrategy.author || 'Unknown';
        document.getElementById('strategy-created-date').textContent = currentStrategy.created_date || 'N/A';
        document.getElementById('strategy-display-info').textContent = currentStrategy.display_info ? `${currentStrategy.display_info}s` : 'N/A';
        document.getElementById('strategy-warmup').textContent = currentStrategy.warmup_period || '100';

        // Trading Config
        const sideMap = {'long_only': 'Long Only', 'short_only': 'Short Only', 'long_short': 'Long & Short'};
        document.getElementById('strategy-trading-side').textContent = sideMap[currentStrategy.trading_side] || currentStrategy.trading_side;
        document.getElementById('strategy-leverage').textContent = `${currentStrategy.leverage}x`;
        document.getElementById('strategy-max-position').textContent = `$${currentStrategy.max_position_size}`;
        document.getElementById('strategy-primary-tf').textContent = currentStrategy.primary_timeframe || '15m';

        // Margin Config
        document.getElementById('strategy-set-leverage').textContent = currentStrategy.set_default_leverage ? '‚úÖ Yes' : '‚ùå No';
        document.getElementById('strategy-hedge-mode').textContent = currentStrategy.hedge_mode ? '‚úÖ Enabled' : '‚ùå Disabled';
        document.getElementById('strategy-set-margin').textContent = currentStrategy.set_margin_type ? '‚úÖ Yes' : '‚ùå No';
        document.getElementById('strategy-margin-type').textContent = currentStrategy.margin_type ? currentStrategy.margin_type.toUpperCase() : 'ISOLATED';

        // Symbols
        document.getElementById('symbol-count').textContent = currentStrategy.symbols.length;
        const symbolTags = currentStrategy.symbols.map(symbol =>
            `<span class="symbol-tag">${symbol}</span>`
        ).join('');
        document.getElementById('symbol-tags').innerHTML = symbolTags || '<span class="info-value">No symbol</span>';

        // Backtest Config
        document.getElementById('backtest-enabled').textContent = currentStrategy.backtesting_enabled ? '‚úÖ Enabled' : '‚ùå Disabled';
        document.getElementById('backtest-start').textContent = currentStrategy.backtest_start_date || 'N/A';
        document.getElementById('backtest-end').textContent = currentStrategy.backtest_end_date || 'N/A';
        document.getElementById('backtest-balance').textContent = currentStrategy.initial_balance ? `$${currentStrategy.initial_balance}` : 'N/A';

        // Description
        document.getElementById('strategy-description').textContent =
            currentStrategy.description || 'Description not added';

        // Toggle button
        updateToggleButton();
    }

    function editStrategy() {
        window.location.href = `/strategies/edit/${strategyId}`;
    }

    function updateToggleButton() {
        const btn = document.getElementById('toggle-btn');
        const isActive = currentStrategy.status === 'active';

        btn.innerHTML = isActive ?
            `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
            Durdur` :
            `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            Ba≈ülat`;
    }

    async function toggleStrategy() {
        const action = currentStrategy.status === 'active' ? 'deactivate' : 'activate';

        try {
            const response = await fetch(`/api/strategies/${strategyId}/${action}`, {
                method: 'POST'
            });
            const result = await response.json();

            if (result.status === 'success') {
                showToast('Successful', result.message, 'success');
                loadStrategy(); // Reload to update status
            } else {
                showToast('Error', result.message || 'Operation failed', 'error');
            }
        } catch (error) {
            console.error('Error toggling strategy:', error);
            showToast('Error', 'An error occurred during the operation.', 'error');
        }
    }
</script>
{% endblock %}
